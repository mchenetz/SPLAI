name: Build and Publish Assets

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: release-assets-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Setup ko
        uses: ko-build/setup-ko@v0.8

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Derive version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          short_sha="${GITHUB_SHA::7}"
          ref_name="${GITHUB_REF_NAME}"

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            app_version="${ref_name#v}"
            image_tag="${ref_name#v}"
          else
            app_version="0.0.0-${ref_name}-${short_sha}"
            image_tag="latest"
          fi

          chart_base_version="$(awk '/^version:/ {print $2; exit}' charts/splai/Chart.yaml)"

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            chart_version="${ref_name#v}"
          else
            chart_version="${chart_base_version}-${ref_name}.${GITHUB_RUN_NUMBER}"
          fi

          echo "app_version=${app_version}" >> "$GITHUB_OUTPUT"
          echo "image_tag=${image_tag}" >> "$GITHUB_OUTPUT"
          echo "chart_version=${chart_version}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${short_sha}" >> "$GITHUB_OUTPUT"

      - name: Compile all binaries
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/release

          go build -o dist/release/splai-api-gateway-linux-amd64 ./cmd/api-gateway
          go build -o dist/release/splai-scheduler-linux-amd64 ./cmd/scheduler
          go build -o dist/release/splai-planner-linux-amd64 ./cmd/planner
          go build -o dist/release/splai-operator-linux-amd64 ./cmd/operator
          go build -o dist/release/splai-worker-linux-amd64 ./worker/cmd/worker-agent
          go build -o dist/release/splaictl-linux-amd64 ./cmd/splaictl

          GOOS=linux GOARCH=arm64 go build -o dist/release/splai-api-gateway-linux-arm64 ./cmd/api-gateway
          GOOS=linux GOARCH=arm64 go build -o dist/release/splai-scheduler-linux-arm64 ./cmd/scheduler
          GOOS=linux GOARCH=arm64 go build -o dist/release/splai-planner-linux-arm64 ./cmd/planner
          GOOS=linux GOARCH=arm64 go build -o dist/release/splai-operator-linux-arm64 ./cmd/operator
          GOOS=linux GOARCH=arm64 go build -o dist/release/splai-worker-linux-arm64 ./worker/cmd/worker-agent
          GOOS=linux GOARCH=arm64 go build -o dist/release/splaictl-linux-arm64 ./cmd/splaictl

          (cd dist/release && sha256sum * > SHA256SUMS)

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: splai-binaries-${{ steps.meta.outputs.short_sha }}
          path: dist/release/*

      - name: Lint and render Helm assets
        shell: bash
        run: |
          set -euo pipefail
          helm lint charts/splai
          mkdir -p dist/helm
          helm template splai charts/splai > dist/helm/splai-manifests.yaml

      - name: Build and push container images (multi-arch)
        shell: bash
        env:
          IMAGE_TAG: ${{ steps.meta.outputs.image_tag }}
          APP_VERSION: ${{ steps.meta.outputs.app_version }}
        run: |
          set -euo pipefail

          # API Gateway
          KO_DOCKER_REPO="${REGISTRY}/${OWNER}/splai-api-gateway" \
            ko build --bare --platform=linux/amd64,linux/arm64 --tags "${IMAGE_TAG}" ./cmd/api-gateway

          # Scheduler
          KO_DOCKER_REPO="${REGISTRY}/${OWNER}/splai-scheduler" \
            ko build --bare --platform=linux/amd64,linux/arm64 --tags "${IMAGE_TAG}" ./cmd/scheduler

          # Planner
          KO_DOCKER_REPO="${REGISTRY}/${OWNER}/splai-planner" \
            ko build --bare --platform=linux/amd64,linux/arm64 --tags "${IMAGE_TAG}" ./cmd/planner

          # Operator
          KO_DOCKER_REPO="${REGISTRY}/${OWNER}/splai-operator" \
            ko build --bare --platform=linux/amd64,linux/arm64 --tags "${IMAGE_TAG}" ./cmd/operator

          # Worker
          KO_DOCKER_REPO="${REGISTRY}/${OWNER}/splai-worker-agent" \
            ko build --bare --platform=linux/amd64,linux/arm64 --tags "${IMAGE_TAG}" ./worker/cmd/worker-agent

      - name: Package Helm chart
        id: chart
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/charts
          helm package charts/splai \
            --version "${{ steps.meta.outputs.chart_version }}" \
            --app-version "${{ steps.meta.outputs.app_version }}" \
            --destination dist/charts
          chart_file="$(ls dist/charts/splai-*.tgz | head -n 1)"
          echo "chart_file=${chart_file}" >> "$GITHUB_OUTPUT"

      - name: Push Helm chart to GHCR OCI registry
        shell: bash
        run: |
          set -euo pipefail
          helm push "${{ steps.chart.outputs.chart_file }}" "oci://${REGISTRY}/${OWNER}/charts"

      - name: Tag Helm chart as latest
        shell: bash
        run: |
          set -euo pipefail
          oras cp "${REGISTRY}/${OWNER}/charts/splai:${{ steps.meta.outputs.chart_version }}" "${REGISTRY}/${OWNER}/charts/splai:latest"

      - name: Upload Helm package artifact
        uses: actions/upload-artifact@v4
        with:
          name: splai-helm-chart-${{ steps.meta.outputs.short_sha }}
          path: dist/charts/*.tgz
